# Apache VirtualHost for PayQuetzal

<VirtualHost *:80>
    ServerName hubsistema.com
    ServerAlias www.hubsistema.com

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName hubsistema.com
    ServerAlias www.hubsistema.com

    DocumentRoot /var/www/html/payquetzal

    # SSL certificates (Let's Encrypt)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/hubsistema.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/hubsistema.com/privkey.pem
    SSLCACertificateFile /etc/letsencrypt/live/hubsistema.com/chain.pem

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/payquetzal-error.log
    CustomLog ${APACHE_LOG_DIR}/payquetzal-access.log combined

    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    <Directory "/var/www/html/payquetzal">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # SPA rewrite rules - avoid API and uploads
        RewriteEngine On
        RewriteBase /
        RewriteCond %{REQUEST_URI} !^/api/
        RewriteCond %{REQUEST_URI} !^/uploads/
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Proxy configuration - only for specific routes
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass /api/ http://127.0.0.1:5001/api/
    ProxyPassReverse /api/ http://127.0.0.1:5001/api/

    ProxyPass /health http://127.0.0.1:5001/health
    ProxyPassReverse /health http://127.0.0.1:5001/health

    ProxyPass /uploads/ http://127.0.0.1:5001/uploads/
    ProxyPassReverse /uploads/ http://127.0.0.1:5001/uploads/

    # Prevent proxying static assets (let Apache serve them)
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </LocationMatch>

    # Limits
    LimitRequestBody 52428800
    ProxyTimeout 300
    ProxyBadHeader Ignore
</VirtualHost>
